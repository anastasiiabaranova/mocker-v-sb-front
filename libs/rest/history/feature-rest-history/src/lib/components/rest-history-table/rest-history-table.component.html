<ng-container *tuiLet="page$ | async as page">
	<ng-container *tuiLet="pageSize$ | async as pageSize">
		<ng-container *tuiLet="totalItems$ | async as totalItems">
			<tui-table-pagination
				*ngIf="page !== null && pageSize !== null && totalItems"
				[total]="totalItems"
				[items]="sizeOptions"
				[page]="page"
				[size]="pageSize"
				(pageChange)="changePage($event)"
				(sizeChange)="changePageSize($event)">
			</tui-table-pagination>
		</ng-container>
	</ng-container>
</ng-container>

<tui-loader [overlay]="true" [showLoader]="!!(loading$ | async)">
	<div *tuiLet="history$ | async as history" class="container">
		<ng-container *ngIf="history !== undefined; else skeleton">
			<tui-scrollbar *ngIf="history && history.length; else noHistory">
				<ng-container
					*ngTemplateOutlet="table; context: {$implicit: history}">
				</ng-container>
			</tui-scrollbar>
		</ng-container>
	</div>
</tui-loader>

<ng-template #table let-history>
	<table tuiTable class="table tui-space_bottom-3" [columns]="columns">
		<thead>
			<tr tuiThGroup>
				<th tuiTh class="history-expand">
					<button
						tuiIconButton
						type="button"
						appearance="icon"
						size="xs"
						[icon]="
							expandedRows.length === history.length
								| tuiMapper : getExpandedIcon
						"
						(click)="expandAllRows(history)"></button>
				</th>
				<th tuiTh class="history-date">Время</th>
				<th tuiTh class="history-method">Метод</th>
				<th tuiTh class="history-status">Status Code</th>
				<th tuiTh>Запрос</th>
				<th tuiTh>URL ответа</th>
				<th tuiTh>Источник</th>
				<th tuiTh>Ответ</th>
			</tr>
		</thead>
		<tbody tuiTbody [data]="history">
			<tr *ngFor="let item of history" tuiTr>
				<ng-container
					*tuiLet="
						expandedRows
							| tuiMapper : getExpanded : item.id as expanded
					">
					<td *tuiCell="'expand'" tuiTd class="history-expand">
						<button
							tuiIconButton
							type="button"
							appearance="icon"
							size="xs"
							[icon]="expanded | tuiMapper : getExpandedIcon"
							(click)="expandRow(item.id, expanded)"></button>
					</td>
					<td *tuiCell="'responseTime'" tuiTd class="history-date">
						{{ item.responseTime | tuiMapper : formatDate }}
					</td>
					<td *tuiCell="'method'" tuiTd class="history-method">
						{{ item.method }}
					</td>
					<td *tuiCell="'statusCode'" tuiTd class="history-status">
						{{ item.statusCode }}
					</td>
					<td
						*tuiCell="'queryUrl'"
						tuiTd
						class="history-url"
						[class.history-url_expanded]="expanded">
						{{ item.queryUrl }}
					</td>
					<td
						*tuiCell="'responseUrl'"
						tuiTd
						class="history-url"
						[class.history-url_expanded]="expanded">
						{{ item.responseUrl }}
					</td>
					<td
						*tuiCell="'responseSource'"
						tuiTd
						class="history-source">
						{{ item.responseSource | tuiMapper : getSource }}
					</td>
					<td *tuiCell="'response'" tuiTd class="history-response">
						<div
							class="preview"
							[class.preview_expanded]="expanded">
							{{ item.response }}
						</div>
						<tui-expand [expanded]="expanded">
							<ng-template tuiExpandContent>
								<div class="full-content">
									{{ item.response }}
								</div>
							</ng-template>
						</tui-expand>
					</td>
				</ng-container>
			</tr>
		</tbody>
	</table>
</ng-template>

<ng-template #noHistory>
	<div class="no-history tui-text_h5">Не нашли вызовов</div>
</ng-template>

<ng-template #skeleton>
	<mocker-rest-history-table-skeleton> </mocker-rest-history-table-skeleton>
</ng-template>
